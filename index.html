<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Storm Runner PRO+ (Mobile Fixed v2)</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#001e38">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&display=swap');

  :root{
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-top: env(safe-area-inset-top, 0px);
  }

  html, body{
    margin:0; padding:0; height:100%;
    background:#000; overflow:hidden;
    font-family:'Roboto Mono', monospace;
    user-select:none; -webkit-user-select:none;
    -webkit-touch-callout:none;
    touch-action:none;
  }
  canvas{ display:block; width:100vw; height:100vh; }

  .ui-layer{
    position:absolute; inset:0;
    display:flex; flex-direction:column;
    justify-content:center; align-items:center;
    text-align:center; color:#fff;
    z-index:60;
    pointer-events:none;
  }
  .interactive{ pointer-events:auto !important; background: rgba(0,10,30,0.95); }
  .hidden{ display:none !important; }

  h1{
    font-family:'Black Ops One';
    font-size: clamp(30px, 4.2vw, 46px);
    color:#00d2ff;
    text-shadow:0 0 10px #00d2ff;
    margin: 0 0 8px 0;
  }
  h2{
    color:#ffcc00;
    margin:0 0 14px 0;
    font-size: clamp(16px, 2.3vw, 24px);
  }

  .btn{
    background: linear-gradient(180deg, #00d2ff, #0077ff);
    border:2px solid white; color:white;
    padding: 12px 30px;
    font-family:'Black Ops One';
    font-size: 18px;
    cursor:pointer;
    margin:10px;
    border-radius:12px;
    box-shadow:0 0 15px #0077ff;
    pointer-events:auto;
    min-width: 220px;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform:scale(0.97); background:#0055aa; }
  .btn.secondary{
    background: rgba(255,255,255,0.14);
    box-shadow:none;
    border-color: rgba(255,255,255,0.45);
  }

  /* HUD */
  #hud{
    position:absolute;
    top: var(--safe-top);
    left:0;
    width:100%;
    padding: 10px 12px;
    display:flex;
    flex-direction: column;
    gap: 8px;
    color:#fff;
    font-weight:bold;
    z-index:30;
    box-sizing:border-box;
    font-size: 16px;
    text-shadow: 1px 1px 2px black;
    pointer-events:none;
  }
  #hudTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  #hudMid{
    display:flex;
    gap: 12px;
    align-items:center;
    justify-content:center;
    flex:1;
    pointer-events:none;
  }

  #pauseBtn, #settingsBtn{
    pointer-events:auto;
    width: 44px;
    height: 36px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.75);
    background: rgba(255,255,255,0.12);
    display:flex;
    align-items:center;
    justify-content:center;
    font-family: 'Black Ops One';
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }
  #pauseBtn:active, #settingsBtn:active{ transform:scale(0.97); background: rgba(255,255,255,0.22); }

  /* Barra progreso */
  #progressWrap{
    width: 100%;
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 0 2px;
    box-sizing:border-box;
  }
  #progressLabel{
    font-family:'Black Ops One';
    font-size: 12px;
    color: rgba(255,255,255,0.9);
    letter-spacing: 0.5px;
    min-width: 84px;
  }
  #progressBar{
    flex: 1;
    height: 12px;
    border-radius: 999px;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.22);
    overflow: hidden;
  }
  #progressFill{
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(0,210,255,0.9), rgba(255,204,0,0.9));
  }
  #progressPct{
    font-size: 12px;
    min-width: 44px;
    text-align:right;
    opacity: 0.9;
  }

  #hudBottom{
    display:flex;
    justify-content:space-between;
    gap:12px;
    font-size: 12px;
    opacity: 0.95;
    align-items: center;
  }
  #missionText{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 54vw; }
  #comboText{ font-family:'Black Ops One'; letter-spacing:0.5px; }
  #streakText{
    font-family:'Black Ops One';
    letter-spacing:0.4px;
    opacity: 0.95;
  }

  #timers{ display:flex; gap: 10px; font-size: 12px; opacity: 0.95; }
  .timerPill{
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(0,0,0,0.18);
    font-family:'Black Ops One';
    letter-spacing: 0.4px;
    white-space: nowrap;
  }

  /* CONTROLES M√ìVILES */
  #mobileControls{
    display:none;
    position:absolute;
    inset:0;
    pointer-events:none;
    z-index:40;
  }
  .touch-area{
    pointer-events:auto;
    position:absolute;
    width: 92px;
    height: 92px;
    background: rgba(255,255,255,0.10);
    border: 2px solid rgba(255,255,255,0.25);
    border-radius: 50%;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size: 34px;
    color:#fff;
    -webkit-tap-highlight-color: transparent;
    backdrop-filter: blur(3px);
  }
  .touch-area:active{ background: rgba(255,255,255,0.22); }
  #btn-left { left: 16px; bottom: calc(16px + var(--safe-bottom)); }
  #btn-right { left: 120px; bottom: calc(16px + var(--safe-bottom)); }
  #btn-jump{
    right: 16px;
    bottom: calc(16px + var(--safe-bottom));
    width: 104px;
    height: 104px;
    background: rgba(0, 210, 255, 0.18);
    border-color: rgba(0, 210, 255, 0.35);
  }

  /* TIENDA */
  .perk-grid{
    display:flex; gap:10px;
    flex-wrap:wrap; justify-content:center;
    margin-bottom: 18px;
    padding: 0 12px;
  }
  .perk-card{
    border:2px solid #555;
    background: rgba(0,0,0,0.6);
    padding: 10px 12px;
    border-radius: 12px;
    cursor:pointer;
    pointer-events:auto;
    min-width: 130px;
    -webkit-tap-highlight-color: transparent;
  }
  .perk-card:active{
    background:#00d2ff; color:#000;
    border-color:#fff;
    transform: scale(0.97);
  }
  .perk-icon{ font-size: 30px; display:block; margin-bottom: 6px; }
  .price{ font-size: 12px; color: gold; font-weight:bold; }

  .panel{
    width: min(760px, 92vw);
    border: 2px solid rgba(255,255,255,0.25);
    border-radius: 16px;
    padding: 18px 14px;
    background: rgba(0,0,0,0.35);
    box-shadow: 0 0 30px rgba(0,0,0,0.45);
  }

  #tip{
    position:absolute;
    bottom: calc(8px + var(--safe-bottom));
    width:100%;
    text-align:center;
    color: rgba(255,255,255,0.75);
    font-size: 12px;
    z-index: 25;
    pointer-events:none;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  }

  /* Overlay rotate */
  #rotateOverlay{
    position:absolute; inset:0;
    display:none;
    align-items:center; justify-content:center;
    text-align:center;
    z-index: 80;
    background: rgba(0,0,0,0.88);
    color:#fff;
    padding: 20px;
  }
  #rotateOverlay .box{
    width: min(560px, 92vw);
    border: 2px solid rgba(255,255,255,0.20);
    border-radius: 16px;
    padding: 16px;
    background: rgba(10,20,40,0.55);
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
  }

  /* Loading */
  #loading{
    position:absolute; inset:0;
    display:flex;
    justify-content:center;
    align-items:center;
    background: radial-gradient(circle at 40% 20%, rgba(0,210,255,0.18), rgba(0,0,0,0.92) 55%);
    z-index: 100;
    color:#fff;
    text-align:center;
  }
  #loading .card{
    width:min(520px, 90vw);
    padding:18px 14px;
    border:2px solid rgba(255,255,255,0.18);
    border-radius:16px;
    background: rgba(0,0,0,0.35);
    box-shadow: 0 0 30px rgba(0,0,0,0.55);
  }
  #loadBar{
    width:100%;
    height:12px;
    border-radius:999px;
    background: rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.20);
    overflow:hidden;
    margin-top: 10px;
  }
  #loadFill{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(0,210,255,0.9), rgba(255,204,0,0.9));
  }

  #toast{
    position:absolute;
    top: calc(12px + var(--safe-top));
    left: 50%;
    transform: translateX(-50%);
    z-index: 90;
    padding: 10px 12px;
    border-radius: 14px;
    background: rgba(0,0,0,0.55);
    border: 1px solid rgba(255,255,255,0.20);
    box-shadow: 0 0 18px rgba(0,0,0,0.45);
    font-family: 'Black Ops One';
    opacity: 0;
    pointer-events:none;
    transition: opacity .2s ease;
  }
  #toast.show{ opacity: 1; }
</style>
</head>

<body>

  <div id="loading">
    <div class="card">
      <h1 style="margin:0;">STORM RUNNER</h1>
      <h2 style="margin:0;">Cargando...</h2>
      <div id="loadBar"><div id="loadFill"></div></div>
      <div style="opacity:.8; font-size:13px; margin-top:10px;">
        Tip: En m√≥vil, se recomienda jugar en horizontal.
      </div>
    </div>
  </div>

  <div id="toast">üèÜ Logro desbloqueado</div>

  <div id="rotateOverlay">
    <div class="box">
      <h1>Gira tu tel√©fono</h1>
      <h2>Optimizado para horizontal (landscape)</h2>
      <div style="font-size:42px; margin-top:10px;">üì±‚Ü©Ô∏è</div>
      <p style="opacity:.85; margin:10px 0 0 0;">En horizontal el juego contin√∫a.</p>
    </div>
  </div>

  <div id="menu" class="ui-layer interactive hidden">
    <h1>STORM RUNNER</h1>
    <h2>Mobile Fixed v2</h2>
    <button class="btn" id="btnPlay">JUGAR</button>
    <button class="btn secondary hidden" id="btnContinue">‚ñ∂ CONTINUAR</button>
    <button class="btn secondary" id="btnResetSave">üßπ BORRAR GUARDADO</button>
    <div style="max-width:780px; padding:0 16px; opacity:.9; line-height:1.35">
      <p style="margin:8px 0 0 0;">‚¨ÖÔ∏è‚û°Ô∏è moverte. ‚¨ÜÔ∏è salto (mantener = m√°s alto).</p>
      <p style="margin:6px 0 0 0; font-size:13px;">En m√≥vil: velocidad m√°s lenta + vista ‚Äúzoom out‚Äù ‚úÖ</p>
    </div>
  </div>

  <div id="shop" class="ui-layer interactive hidden">
    <h2 style="color:#00ff00">TIENDA</h2>
    <div style="opacity:.85; margin-bottom: 10px;">
      Tus üü°: <b><span id="shopCoins">0</span></b>
    </div>
    <div class="perk-grid">
      <div class="perk-card" id="buyHealth"><span class="perk-icon">‚ù§Ô∏è</span><div>+VIDA</div><div class="price">100 üü°</div></div>
      <div class="perk-card" id="buyShield"><span class="perk-icon">üõ°Ô∏è</span><div>ESCUDO (10s)</div><div class="price">150 üü°</div></div>
      <div class="perk-card" id="buyMagnet"><span class="perk-icon">üß≤</span><div>IM√ÅN (10s)</div><div class="price">200 üü°</div></div>
      <div class="perk-card" id="buyDouble"><span class="perk-icon">ü™Ω</span><div>DOBLE SALTO</div><div class="price">250 üü°</div></div>
    </div>
    <button class="btn" id="btnNext">CONTINUAR ‚ñ∂</button>
    <p id="shopHint" style="font-size:12px; opacity:.85; max-width:780px; padding:0 16px; line-height:1.35; margin: 10px 0 0 0;"></p>
  </div>

  <div id="levelDone" class="ui-layer interactive hidden">
    <div class="panel">
      <h1 style="font-size:34px;margin:0 0 6px 0;">¬°NIVEL COMPLETADO!</h1>
      <h2 style="margin:0;">Pasando al siguiente...</h2>
    </div>
  </div>

  <div id="gameover" class="ui-layer interactive hidden">
    <h1 style="color:#ff4444">GAME OVER</h1>
    <p style="font-size:20px; color:white; margin: 10px 0 14px 0;">Puntaje: <span id="scoreVal">0</span></p>
    <button class="btn" id="btnRetry">REINTENTAR</button>
    <button class="btn secondary" id="btnGoMenu">MEN√ö</button>
  </div>

  <div id="hud" class="hidden">
    <div id="hudTop">
      <div>‚ù§Ô∏è <span id="lives">3</span></div>
      <div id="hudMid">
        <div id="zoneTitle">ZONA 1</div>
        <div>üü° <span id="coins">0</span></div>
      </div>
      <div style="opacity:.9;">FPS</div>
    </div>

    <div id="progressWrap">
      <div id="progressLabel">PROGRESO</div>
      <div id="progressBar"><div id="progressFill"></div></div>
      <div id="progressPct">0%</div>
    </div>

    <div id="hudBottom">
      <div id="missionText">Misi√≥n: ...</div>
      <div style="display:flex; gap: 10px; align-items:center;">
        <div id="streakText">Racha 0 (x1.00)</div>
        <div id="comboText">COMBO x1</div>
      </div>
    </div>
  </div>

  <div id="tip" class="hidden">Mant√©n ‚¨ÜÔ∏è para salto alto.</div>

  <div id="mobileControls">
    <div id="btn-left" class="touch-area">‚¨ÖÔ∏è</div>
    <div id="btn-right" class="touch-area">‚û°Ô∏è</div>
    <div id="btn-jump" class="touch-area">‚¨ÜÔ∏è</div>
  </div>

  <canvas id="canvas"></canvas>

<script>
(() => {
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand  = (a,b)=>a+Math.random()*(b-a);

  const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
  const isMobileLike = isTouch || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const rotateOverlay = document.getElementById('rotateOverlay');

  // ===== Canvas =====
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });

  if (isTouch) document.getElementById('mobileControls').style.display = 'block';

  let DPR=1, W=0, H=0, seaLevel=0;

  // ===== ‚ÄúZoom out‚Äù solo en m√≥vil =====
  // Escala visual del mundo. En m√≥vil mostramos m√°s √°rea (zoom out).
  // Si quieres a√∫n m√°s ‚Äúchico‚Äù, baja a 0.82
  let viewScale = isMobileLike ? 0.88 : 1.0;

  // ===== UI refs =====
  const loading = document.getElementById('loading');
  const loadFill = document.getElementById('loadFill');
  const elMenu = document.getElementById('menu');
  const elShop = document.getElementById('shop');
  const elDone = document.getElementById('levelDone');
  const elOver = document.getElementById('gameover');
  const elHUD  = document.getElementById('hud');
  const elTip  = document.getElementById('tip');

  const elLives= document.getElementById('lives');
  const elCoins= document.getElementById('coins');
  const elZone = document.getElementById('zoneTitle');
  const elScore= document.getElementById('scoreVal');

  const elProgFill= document.getElementById('progressFill');
  const elProgPct = document.getElementById('progressPct');

  const elMission= document.getElementById('missionText');
  const elCombo  = document.getElementById('comboText');
  const elStreak = document.getElementById('streakText');

  const elShopCoins= document.getElementById('shopCoins');
  const elShopHint = document.getElementById('shopHint');

  const btnContinue = document.getElementById('btnContinue');

  // ===== Storage =====
  const KEY_SAVE = "sr_autosave_fix_v2";

  function saveJSON(key, value){ try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){} }
  function loadJSON(key, fallback){
    try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):fallback; }
    catch(e){ return fallback; }
  }
  function hasSave(){ const s=loadJSON(KEY_SAVE,null); return !!(s && typeof s.level==="number"); }
  function clearSave(){ try{localStorage.removeItem(KEY_SAVE);}catch(e){} btnContinue.classList.add('hidden'); }

  // ===== Audio minimal =====
  const AudioEngine = {
    ctx:null,
    ensure(){
      if(!this.ctx){
        try{ this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch(e){ return null; }
      }
      if(this.ctx.state==="suspended") this.ctx.resume().catch(()=>{});
      return this.ctx;
    },
    play(type){
      const ac=this.ensure(); if(!ac) return;
      const osc=ac.createOscillator();
      const gain=ac.createGain();
      osc.connect(gain); gain.connect(ac.destination);
      const now=ac.currentTime;

      if(type==='jump'){
        osc.type='sine';
        osc.frequency.setValueAtTime(170,now);
        osc.frequency.linearRampToValueAtTime(360,now+0.08);
        gain.gain.setValueAtTime(0.08,now);
        gain.gain.exponentialRampToValueAtTime(0.0001,now+0.12);
        osc.start(); osc.stop(now+0.13); return;
      }
      if(type==='coin'){
        osc.type='triangle';
        osc.frequency.setValueAtTime(1200,now);
        osc.frequency.linearRampToValueAtTime(2100,now+0.07);
        gain.gain.setValueAtTime(0.06,now);
        gain.gain.exponentialRampToValueAtTime(0.0001,now+0.10);
        osc.start(); osc.stop(now+0.11); return;
      }
      if(type==='hit'){
        osc.type='sawtooth';
        osc.frequency.setValueAtTime(120,now);
        osc.frequency.linearRampToValueAtTime(70,now+0.12);
        gain.gain.setValueAtTime(0.12,now);
        gain.gain.exponentialRampToValueAtTime(0.0001,now+0.16);
        osc.start(); osc.stop(now+0.17); return;
      }
      if(type==='land'){
        osc.type='sine';
        osc.frequency.setValueAtTime(240,now);
        osc.frequency.linearRampToValueAtTime(160,now+0.07);
        gain.gain.setValueAtTime(0.045,now);
        gain.gain.exponentialRampToValueAtTime(0.0001,now+0.10);
        osc.start(); osc.stop(now+0.11); return;
      }
    }
  };
  function vibrateSoft(ms){
    if(!isMobileLike) return;
    if(navigator.vibrate) navigator.vibrate(ms);
  }

  // ===== Game state =====
  let playing=false;
  let level=1;
  let lastTime=0;

  const player = {
    x:60, y:0, vy:0, grounded:false,
    lives:3, coins:0, score:0,
    doubleJump:false,
    extraJumpReady:false,
    jumpBuffer:0,
    coyote:0,
    jumping:false,
    jumpHold:0,
    combo:1,
    comboTimer:0,
    squash:0,
    lastVy:0
  };

  let obstacles=[];
  let coins=[];
  let powerups=[];
  let patternQueue=[];
  let tPattern=0;
  let tPower=0;

  let mission={ type:'time', target:20, progress:0 };

  let streakCoinsNoHit=0;

  // ===== Fix del bug: enqueuePattern REAL =====
  function enqueuePattern(){
    const hard = level>=4;

    const patterns = [];

    patterns.push(()=>{ // olas + premio
      const count = hard ? 3 : 2;
      for(let i=0;i<count;i++) patternQueue.push({ type:'wave', delay:i*(hard?0.42:0.56) });
      patternQueue.push({ type:'coinPrize', delay:(hard?0.42:0.56)*count + 0.12 });
    });

    patterns.push(()=>{ // pez + monedas
      patternQueue.push({ type:'fish', delay:0.12 });
      patternQueue.push({ type:'coinEasy', delay:0.22 });
      if(hard) patternQueue.push({ type:'coinMid', delay:0.36 });
    });

    patterns.push(()=>{ // roca + moneda media
      patternQueue.push({ type:'rock', delay:0.10 });
      patternQueue.push({ type:'coinMid', delay:0.28 });
    });

    patterns.push(()=>{ // burbuja + premio
      patternQueue.push({ type:'bubble', delay:0.12 });
      patternQueue.push({ type:'coinPrize', delay:0.24 });
    });

    patterns.push(()=>{ // tibur√≥n + f√°cil
      patternQueue.push({ type:'shark', delay:0.14 });
      patternQueue.push({ type:'coinEasy', delay:0.26 });
    });

    patterns[Math.floor(Math.random()*patterns.length)]();
  }

  function runPatternQueue(dt){
    for(let i=0;i<patternQueue.length;i++) patternQueue[i].delay -= dt;
    let spawned=true;
    while(spawned){
      spawned=false;
      for(let i=0;i<patternQueue.length;i++){
        if(patternQueue[i].delay<=0){
          const job=patternQueue.splice(i,1)[0];
          spawnFromJob(job.type);
          spawned=true;
          break;
        }
      }
    }
  }

  // ===== Difficulty =====
  function difficultyForLevel(lvl){
    const baseJump = clamp(860 + lvl*10, 780, 1040);
    const gravity  = clamp(1650 + lvl*55, 1550, 3100);
    const moveSpeed= clamp(400 + lvl*12, 400, 560);
    const holdTime = clamp(0.235 + lvl*0.002, 0.235, 0.255);
    const holdGravityFactor = 0.44;
    const spawnTightness = clamp(1.10 - lvl*0.045, 0.62, 1.10);
    return { baseJump, gravity, moveSpeed, holdTime, holdGravityFactor, spawnTightness };
  }

  // ===== Velocidad: m√°s lenta solo m√≥vil =====
  function worldSpeedMultiplier(){
    let m=1.0;
    if(isMobileLike) m*=0.75;  // <-- FIX principal (antes iba demasiado r√°pido)
    return m;
  }

  function maxJumpHeightPx(diff){
    const g1=diff.gravity*diff.holdGravityFactor;
    const v=diff.baseJump;
    return clamp((v*v)/(2*g1), 200, 430);
  }

  // ===== Missions =====
  function setMissionForLevel(lvl){
    const pick=lvl%3;
    if(pick===1){ mission={type:'time', target: clamp(18+lvl*2,18,44), progress:0}; elMission.textContent=`Misi√≥n: Sobrevive ${mission.target}s`; }
    else if(pick===2){ mission={type:'coins', target: clamp(120+lvl*30,120,520), progress:0}; elMission.textContent=`Misi√≥n: Recolecta ${mission.target}üü°`; }
    else { mission={type:'waves', target: clamp(10+lvl*3,10,44), progress:0}; elMission.textContent=`Misi√≥n: Pasa ${mission.target} olas`; }
  }
  function missionProgress01(){ return clamp(mission.progress/mission.target,0,1); }
  function updateProgressUI(){
    const pct=Math.floor(missionProgress01()*100);
    elProgFill.style.width=pct+"%";
    elProgPct.textContent=pct+"%";
  }

  // ===== Multiplicador racha =====
  function streakMultiplier(){
    const steps=Math.floor(streakCoinsNoHit/10);
    return clamp(1+steps*0.10,1,1.50);
  }

  function updateHUD(){
    elLives.textContent=player.lives;
    elCoins.textContent=player.coins;
    elCombo.textContent=`COMBO x${player.combo}`;
    elStreak.textContent=`Racha ${streakCoinsNoHit} (x${streakMultiplier().toFixed(2)})`;
    elZone.textContent=`ZONA ${level}`;
  }

  // ===== Resize + view scaling =====
  function isPortraitOnMobile(){ return isMobileLike && window.innerHeight > window.innerWidth; }

  function resize(){
    DPR = Math.min(window.devicePixelRatio || 1, 1.6);
    W = Math.floor(window.innerWidth);
    H = Math.floor(window.innerHeight);

    canvas.width = Math.floor(W*DPR);
    canvas.height = Math.floor(H*DPR);
    canvas.style.width = W+"px";
    canvas.style.height = H+"px";
    ctx.setTransform(DPR,0,0,DPR,0,0);

    seaLevel = H - Math.max(120, Math.min(150, H*0.22));
    rotateOverlay.style.display = isPortraitOnMobile() ? "flex" : "none";

    // si el m√≥vil es muy ‚Äúestrecho‚Äù, hacemos un poco m√°s zoom out
    if (isMobileLike){
      const ar = W / H;
      viewScale = (ar < 1.6) ? 0.84 : 0.88;
    } else {
      viewScale = 1.0;
    }
  }
  window.addEventListener('resize', resize, { passive:true });

  // ===== Drawing helpers (aplica zoom out) =====
  function beginWorld(){
    ctx.save();
    // Centramos el mundo y lo escalamos.
    ctx.translate(W/2, H/2);
    ctx.scale(viewScale, viewScale);
    ctx.translate(-W/2, -H/2);
  }
  function endWorld(){ ctx.restore(); }

  // ===== Spawns =====
  function spawnWave(){
    const diff=difficultyForLevel(level);
    const maxH=maxJumpHeightPx(diff);
    const ease=clamp(1.0-(level-1)*0.035,0.82,1.0);
    const waveCap=clamp(maxH*0.55*ease, 90, 190);

    let h=60+Math.random()*52;
    h=clamp(h,50,waveCap);
    let w=70+Math.random()*60;

    obstacles.push({ kind:'wave', x:W+30, y:seaLevel-h+22, w, h, dead:false });
    if(mission.type==='waves') mission.progress=Math.min(mission.target, mission.progress+1);
  }
  function spawnRock(){ obstacles.push({ kind:'rock', x:W+30, y:seaLevel-rand(70,200), w:46, h:34, dead:false }); }
  function spawnBubble(){ obstacles.push({ kind:'bubble', x:W+30, y:seaLevel-rand(40,160), w:34, h:34, dead:false, push: rand(260,420) }); }
  function spawnFish(){
    const jumpPower = clamp(620 + level*26, 620, 980);
    const fishG = clamp(2100 + level*80, 2100, 3300);
    obstacles.push({ kind:'fish', x:W+30, baseY:seaLevel+30, y:seaLevel+30, vy:-jumpPower, g:fishG, w:42, h:32, dead:false });
  }
  function spawnShark(){ obstacles.push({ kind:'shark', x:W+30, y:seaLevel+18, w:62, h:34, dead:false }); }

  function spawnCoin(tier){
    const diff=difficultyForLevel(level);
    const maxH=maxJumpHeightPx(diff);

    let up;
    if(tier==='easy') up=70+Math.random()*70;
    else if(tier==='mid') up=clamp(maxH*(0.55+Math.random()*0.15),130,240);
    else up=clamp(maxH*(0.78+Math.random()*0.10),200,320);

    coins.push({
      x:W+10,
      y:seaLevel-up,
      dead:false,
      tier,
      value: tier==='prize'?25:(tier==='mid'?15:10),
      bonusScore: tier==='prize'?110:(tier==='mid'?70:50)
    });
  }

  function spawnPowerup(kind){
    powerups.push({ kind, x:W+30, y:seaLevel-rand(120,220), dead:false });
  }

  function spawnFromJob(type){
    if(type==='wave') spawnWave();
    else if(type==='rock') spawnRock();
    else if(type==='bubble') spawnBubble();
    else if(type==='fish') spawnFish();
    else if(type==='shark') spawnShark();
    else if(type==='coinEasy') spawnCoin('easy');
    else if(type==='coinMid') spawnCoin('mid');
    else if(type==='coinPrize') spawnCoin('prize');
  }

  // ===== Collisions =====
  function aabb(ax,ay,aw,ah,bx,by,bw,bh){
    return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;
  }

  function hitPlayer(){
    player.lives--;
    AudioEngine.play('hit');
    vibrateSoft(25);
    streakCoinsNoHit=0;
    player.combo=1;
    updateHUD();
    if(player.lives<=0) gameOver();
  }

  // ===== Jump =====
  function tryJump(diff){
    const canGroundJump = player.grounded || player.coyote>0;
    const canDouble = player.doubleJump && player.extraJumpReady && !canGroundJump;

    if(player.jumpBuffer>0 && (canGroundJump || canDouble)){
      player.jumpBuffer=0;
      player.jumping=true;
      player.jumpHold=diff.holdTime;

      if(canDouble) player.extraJumpReady=false;

      player.vy = -diff.baseJump;
      player.grounded=false;
      player.coyote=0;

      AudioEngine.play('jump');
      vibrateSoft(8);
    }
  }

  // ===== Update =====
  function update(dt){
    if(isPortraitOnMobile()) return;

    const diff=difficultyForLevel(level);
    const spMul=worldSpeedMultiplier();

    // mission time
    if(mission.type==='time') mission.progress=Math.min(mission.target, mission.progress+dt);

    // movement
    const move=diff.moveSpeed*(isMobileLike?0.95:1.0);
    if(keys.left) player.x-=move*dt;
    if(keys.right) player.x+=move*dt;
    player.x=clamp(player.x,0,W-40);

    // buffers
    if(player.jumpBuffer>0) player.jumpBuffer=Math.max(0, player.jumpBuffer-dt);
    if(player.grounded) player.coyote=0.12; else player.coyote=Math.max(0, player.coyote-dt);

    // try jump
    tryJump(diff);

    // variable jump
    let g=diff.gravity;
    if(player.jumping && keys.jump && player.jumpHold>0){
      player.jumpHold=Math.max(0, player.jumpHold-dt);
      g*=diff.holdGravityFactor;
    }else{
      player.jumping=false;
      player.jumpHold=0;
    }

    const wasGrounded=player.grounded;
    const prevVy=player.vy;

    player.vy += g*dt;
    player.y += player.vy*dt;

    if(player.y>=seaLevel){
      player.y=seaLevel;
      player.vy=0;
      player.grounded=true;
      player.jumping=false;
      player.jumpHold=0;
      player.extraJumpReady=player.doubleJump;

      if(!wasGrounded && prevVy>650){
        AudioEngine.play('land');
        vibrateSoft(10);
      }
    }else{
      player.grounded=false;
    }

    player.lastVy=player.vy;

    // spawns (FIX)
    tPattern -= dt*spMul;
    if(tPattern<=0){
      enqueuePattern();
      tPattern = rand(0.95,1.25)*diff.spawnTightness;
    }
    runPatternQueue(dt);

    tPower -= dt*spMul;
    if(tPower<=0){
      const roll=Math.random();
      if(roll<0.33) spawnPowerup('shield');
      else if(roll<0.66) spawnPowerup('magnet');
      else spawnPowerup('double');
      tPower=rand(7.5,10.5);
    }

    // world speed
    const worldSpeedPx=(5.6 + level*0.55) * 60 * dt * spMul;

    // obstacles update
    for(const o of obstacles){
      o.x -= worldSpeedPx;
      if(o.kind==='fish'){
        o.vy += o.g*dt;
        o.y += o.vy*dt;
        if(o.y>=o.baseY){ o.y=o.baseY; o.vy=-rand(520,900); }
      }
      if(o.x<-220) o.dead=true;
    }

    // coins update
    for(const c of coins){
      c.x -= worldSpeedPx;
      if(c.x<-220) c.dead=true;
    }

    // powerups update
    for(const p of powerups){
      p.x -= worldSpeedPx;
      if(p.x<-220) p.dead=true;
    }

    // collisions obstacles
    const px=player.x, py=player.y, pw=40, ph=40;
    for(const o of obstacles){
      if(o.dead) continue;
      if(aabb(px+8,py+8,pw-16,ph-12,o.x+8,o.y+8,o.w-16,o.h-10)){
        if(o.kind==='bubble'){
          player.vy = Math.min(player.vy, -o.push);
          o.dead=true;
        }else{
          o.dead=true;
          hitPlayer();
        }
      }
    }

    // coins pickup
    for(const c of coins){
      if(c.dead) continue;
      if(Math.abs((px+20)-c.x)<24 && Math.abs((py+20)-c.y)<24){
        c.dead=true;

        streakCoinsNoHit++;
        const mult=streakMultiplier();

        const gained=Math.round(c.value*mult);
        player.coins += gained*player.combo;
        player.score += c.bonusScore*player.combo;

        if(mission.type==='coins') mission.progress=Math.min(mission.target, mission.progress+gained);

        // combo
        player.combo=clamp(player.combo+1,1,5);
        player.comboTimer=2.0;

        AudioEngine.play('coin');
        updateHUD();
      }
    }

    // powerups pickup
    for(const p of powerups){
      if(p.dead) continue;
      if(Math.abs((px+20)-p.x)<26 && Math.abs((py+20)-p.y)<26){
        p.dead=true;
        if(p.kind==='double'){ player.doubleJump=true; player.extraJumpReady=true; }
        AudioEngine.play('coin');
      }
    }

    // combo decay
    if(player.combo>1){
      player.comboTimer-=dt;
      if(player.comboTimer<=0){ player.combo=1; player.comboTimer=0; }
    }

    obstacles=obstacles.filter(o=>!o.dead);
    coins=coins.filter(c=>!c.dead);
    powerups=powerups.filter(p=>!p.dead);

    // score
    player.score += dt*10;

    updateProgressUI();

    // level complete
    if(mission.progress>=mission.target) levelComplete();
  }

  // ===== Draw =====
  function draw(){
    // Fondo
    ctx.fillStyle="#001e38";
    ctx.fillRect(0,0,W,H);

    // mundo escalado (zoom out en m√≥vil)
    beginWorld();

    // agua
    ctx.fillStyle="rgba(0,100,200,0.8)";
    ctx.fillRect(0, seaLevel+20, W, H);

    // olas superficie
    ctx.fillStyle="rgba(0,180,255,0.35)";
    ctx.fillRect(0, seaLevel+20, W, 8);

    // obst√°culos
    for(const o of obstacles){
      if(o.kind==='wave'){
        ctx.fillStyle="rgba(0,180,255,0.85)";
        ctx.beginPath();
        ctx.moveTo(o.x, o.y+o.h);
        ctx.quadraticCurveTo(o.x+o.w/2, o.y-18, o.x+o.w, o.y+o.h);
        ctx.closePath();
        ctx.fill();
      }else if(o.kind==='shark'){
        ctx.font="28px Arial"; ctx.fillText("ü¶à", o.x, o.y+28);
      }else if(o.kind==='fish'){
        ctx.font="26px Arial"; ctx.fillText("üêü", o.x, o.y+26);
      }else if(o.kind==='rock'){
        ctx.font="26px Arial"; ctx.fillText("ü™®", o.x, o.y+26);
      }else if(o.kind==='bubble'){
        ctx.font="26px Arial"; ctx.fillText("ü´ß", o.x, o.y+26);
      }
    }

    // monedas
    for(const c of coins){
      if(c.tier==='prize'){
        ctx.fillStyle="gold";
        ctx.beginPath(); ctx.arc(c.x,c.y,12,0,Math.PI*2); ctx.fill();
      }else if(c.tier==='mid'){
        ctx.fillStyle="rgba(255,215,0,0.9)";
        ctx.beginPath(); ctx.arc(c.x,c.y,10,0,Math.PI*2); ctx.fill();
      }else{
        ctx.fillStyle="rgba(255,215,0,0.75)";
        ctx.beginPath(); ctx.arc(c.x,c.y,9,0,Math.PI*2); ctx.fill();
      }
    }

    // powerups
    for(const p of powerups){
      ctx.font="22px Arial";
      const icon = p.kind==='double' ? "ü™Ω" : (p.kind==='magnet' ? "üß≤" : "üõ°Ô∏è");
      ctx.fillText(icon, p.x-10, p.y+10);
    }

    // barco
    const tilt = clamp(player.lastVy*0.0022, -0.28, 0.30);
    ctx.save();
    ctx.translate(player.x+20, player.y+20);
    ctx.rotate(tilt);
    ctx.fillStyle="#ff9900";
    ctx.beginPath();
    ctx.moveTo(-20,0); ctx.lineTo(20,0);
    ctx.lineTo(15,20); ctx.lineTo(-15,20);
    ctx.closePath(); ctx.fill();

    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.moveTo(0,-30); ctx.lineTo(0,0); ctx.lineTo(20,-10);
    ctx.closePath(); ctx.fill();
    ctx.restore();

    endWorld();
  }

  // ===== Loop =====
  function loop(now){
    if(!playing) return;

    rotateOverlay.style.display = isPortraitOnMobile() ? "flex" : "none";

    const dt = Math.min(0.033, (now-lastTime)/1000 || 0.016);
    lastTime = now;

    update(dt);
    draw();

    requestAnimationFrame(loop);
  }

  // ===== Level flow =====
  function autosave(){
    saveJSON(KEY_SAVE, {
      level, lives: player.lives, coins: player.coins, score: player.score,
      doubleJump: player.doubleJump
    });
    btnContinue.classList.remove('hidden');
  }

  function loadSave(){
    const s=loadJSON(KEY_SAVE,null);
    if(!s) return false;
    level=s.level||1;
    player.lives=s.lives??3;
    player.coins=s.coins??0;
    player.score=s.score??0;
    player.doubleJump=!!s.doubleJump;
    player.extraJumpReady=player.doubleJump;
    return true;
  }

  function startLevel(lvl){
    level=lvl;

    obstacles=[]; coins=[]; powerups=[];
    patternQueue=[]; tPattern=0; tPower=0;

    player.x=60;
    player.y=seaLevel;
    player.vy=0;
    player.grounded=true;
    player.jumpBuffer=0;
    player.coyote=0;
    player.jumping=false;
    player.jumpHold=0;
    player.extraJumpReady=player.doubleJump;

    streakCoinsNoHit=0;
    player.combo=1; player.comboTimer=0;

    setMissionForLevel(level);
    updateProgressUI();
    updateHUD();

    playing=true;
    elMenu.classList.add('hidden');
    elShop.classList.add('hidden');
    elDone.classList.add('hidden');
    elOver.classList.add('hidden');
    elHUD.classList.remove('hidden');
    elTip.classList.remove('hidden');

    autosave();

    lastTime=performance.now();
    requestAnimationFrame(loop);
  }

  function canOpenShopNow(){
    // tienda despu√©s del nivel 2 y si tienes al menos 100
    return level>=2 && player.coins>=100;
  }

  function levelComplete(){
    playing=false;
    elHUD.classList.add('hidden');
    elTip.classList.add('hidden');
    autosave();

    if(canOpenShopNow()){
      elShopCoins.textContent=player.coins;
      elShopHint.textContent="Compra algo y contin√∫a.";
      elShop.classList.remove('hidden');
    }else{
      elDone.classList.remove('hidden');
      setTimeout(()=>{
        elDone.classList.add('hidden');
        startLevel(level+1);
      }, 850);
    }
  }

  function gameOver(){
    playing=false;
    elHUD.classList.add('hidden');
    elTip.classList.add('hidden');
    elOver.classList.remove('hidden');
    elScore.textContent = Math.floor(player.score);
    autosave();
  }

  // ===== Shop =====
  function buy(item){
    if(item==='health' && player.coins>=100){ player.coins-=100; player.lives++; AudioEngine.play('coin'); }
    if(item==='shield' && player.coins>=150){ player.coins-=150; AudioEngine.play('coin'); }
    if(item==='magnet' && player.coins>=200){ player.coins-=200; AudioEngine.play('coin'); }
    if(item==='double' && player.coins>=250){ player.coins-=250; player.doubleJump=true; player.extraJumpReady=true; AudioEngine.play('coin'); }
    elShopCoins.textContent=player.coins;
    updateHUD();
    autosave();
  }

  document.getElementById('buyHealth').onclick=()=>buy('health');
  document.getElementById('buyShield').onclick=()=>buy('shield');
  document.getElementById('buyMagnet').onclick=()=>buy('magnet');
  document.getElementById('buyDouble').onclick=()=>buy('double');

  document.getElementById('btnNext').onclick=()=>{
    elShop.classList.add('hidden');
    startLevel(level+1);
  };

  // ===== Inputs =====
  const keys={ left:false, right:false, jump:false };

  window.addEventListener('keydown',(e)=>{
    if(e.code==='ArrowLeft') keys.left=true;
    if(e.code==='ArrowRight') keys.right=true;
    if(e.code==='Space'){
      keys.jump=true;
      player.jumpBuffer=0.14;
      AudioEngine.ensure();
      e.preventDefault();
    }
  });
  window.addEventListener('keyup',(e)=>{
    if(e.code==='ArrowLeft') keys.left=false;
    if(e.code==='ArrowRight') keys.right=false;
    if(e.code==='Space'){
      keys.jump=false;
      if(player.jumping && player.vy<0) player.vy*=0.60;
      player.jumping=false;
      player.jumpHold=0;
      e.preventDefault();
    }
  });

  function bindHold(id,key,isJump=false){
    const el=document.getElementById(id);
    if(!el) return;

    const down=(e)=>{ e.preventDefault(); keys[key]=true; AudioEngine.ensure(); if(isJump) player.jumpBuffer=0.14; };
    const up=(e)=>{ e.preventDefault(); keys[key]=false;
      if(isJump){ if(player.jumping && player.vy<0) player.vy*=0.60; player.jumping=false; player.jumpHold=0; }
    };

    el.addEventListener('pointerdown',down,{passive:false});
    el.addEventListener('pointerup',up,{passive:false});
    el.addEventListener('pointercancel',up,{passive:false});
    el.addEventListener('pointerleave',up,{passive:false});
    el.addEventListener('touchstart',down,{passive:false});
    el.addEventListener('touchend',up,{passive:false});
  }
  bindHold('btn-left','left');
  bindHold('btn-right','right');
  bindHold('btn-jump','jump',true);

  // ===== Buttons =====
  document.getElementById('btnPlay').onclick=()=>{
    AudioEngine.ensure();
    player.lives=3; player.coins=0; player.score=0; player.doubleJump=false;
    startLevel(1);
  };
  document.getElementById('btnRetry').onclick=()=>startLevel(1);
  document.getElementById('btnGoMenu').onclick=()=>location.reload();
  document.getElementById('btnResetSave').onclick=()=>{ clearSave(); };

  btnContinue.onclick=()=>{
    AudioEngine.ensure();
    if(loadSave()) startLevel(level);
  };

  // ===== Loading + init =====
  let lp=0;
  const loadInterval=setInterval(()=>{
    lp=Math.min(1,lp+0.12);
    loadFill.style.width=Math.floor(lp*100)+"%";
  },90);

  function showMenu(){
    elMenu.classList.remove('hidden');
    elHUD.classList.add('hidden');
    elTip.classList.add('hidden');
    elShop.classList.add('hidden');
    elDone.classList.add('hidden');
    elOver.classList.add('hidden');
    if(hasSave()) btnContinue.classList.remove('hidden'); else btnContinue.classList.add('hidden');
  }

  setTimeout(()=>{
    clearInterval(loadInterval);
    loadFill.style.width="100%";
    setTimeout(()=>{
      loading.classList.add('hidden');
      resize();
      updateHUD();
      updateProgressUI();
      showMenu();
    },200);
  },900);

  window.addEventListener('pointerdown', ()=>AudioEngine.ensure(), { once:true });
})();
</script>
</body>
</html>
